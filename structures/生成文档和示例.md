# éœ€æ±‚èƒŒæ™¯
ç»„ä»¶åº“è¦è¢«äººå®¶ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸€å®šéœ€è¦æœ‰ä½¿ç”¨demoå’ŒAPIè§£æã€‚è¿™ä¸¤ä¸ªå·¥ä½œæ˜¯å¯ä»¥åˆå¹¶åœ¨åŒä¸€ä»½`markdown`æ–‡ä»¶é‡Œé¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æå–`markdown`é‡Œé¢çš„ä»£ç ç‰‡æ®µï¼Œç„¶åæ¸²æŸ“æˆdemoå°±å¯ä»¥ï¼Œè¿™å—æˆ‘ä»¬æ‰‹å†™ä¸€ä¸ªloaderæ¥å¤„ç†ï¼Œå…·ä½“çš„é€»è¾‘åœ¨`build/markdown-loader.js`é‡Œé¢ã€‚

## æ·»åŠ loader
æˆ‘ä»¬è¦è½¬æ¢`.md`æ–‡ä»¶ä¸ºHTMLæ ‡ç­¾ï¼ŒåŒæ—¶æå–é‡Œé¢çš„ä»£ç å—ï¼Œç„¶åå¯¹ä»£ç å—åšä¸€äº›è‡ªå®šä¹‰å¤„ç†ï¼Œæœ€åè¿”å›vueå•æ–‡ä»¶ç»„ä»¶æ¨¡æ¿ï¼Œä¼ é€’ç»™`vue-loader`å»è§£æã€‚å¤šloaderæ˜¯ä¸²è”é“¾å¼è°ƒç”¨çš„ï¼ŒæŒ‰é€†åºæ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨`vue.config.js`é‡Œé¢æ·»åŠ ä¸‹é¢å¯¹`.md`çš„å¤„ç†ğŸ‘‡

```js
config.module
  .rule('md')
  .test(/\.md/)
  .use('vue-loader')
  .loader('vue-loader')
  .options({
    compilerOptions: {
      preserveWhitespace: false
    }
  })
  .end()
  .use('markdown-loader')
  .loader(
    require('path').resolve(__dirname, './build/markdown-loader.js')
  )
  .end();
```

## loaderé€»è¾‘
`markdown-it`è¿™ä¸ªåº“å¯ä»¥æŠŠMarkdownæ–‡æ¡£è½¬æ¢æˆHTMLæ ‡ç­¾ï¼Œé…åˆ`markdown-it-container`è¿™ä¸ªæ’ä»¶å¯ä»¥æå–ç‰¹å®šæ ‡ç­¾å†…å†…å®¹ã€‚åœ¨`steam-game-ui`é‡Œé¢æˆ‘ä»¬å®šä¹‰`:::demo ä»£ç å— :::`é‡Œé¢çš„ä»£ç å—éœ€è¦è¢«æ¸²æŸ“æˆVueç»„ä»¶ã€‚

```js
const md = require('markdown-it')();
const VueTemplateComplier = require('vue-template-compiler');
const { parse, compileTemplate } = require('@vue/component-compiler-utils');
let componentCodeList = [];

md.use(require('markdown-it-container'), 'demo', {
  // éªŒè¯ä»£ç å—ä¸ºã€:::demo :::ã€‘æ‰è¿›è¡Œæ¸²æŸ“
  validate: function(params) {
    return params.trim().match(/^demo\s+(.*)$/);
  },
  // ä»£ç å—æ¸²æŸ“
  render: function (tokens, idx) {
    const token = tokens[index];
      const tokenInfo = token.info.trim().match(/^demo\s*(.*)$/);
      if (token.nesting === 1) { // å¼€å§‹æ ‡ç­¾
        // è·å–demoçš„ç¬¬ä¸€è¡Œä»£ç æè¿°ï¼Œå³::: demo xxx ä¸­çš„xxx
        const desc = tokenInfo && tokenInfo.length > 1 ? tokenInfo[1] : '';
        // è·å–demoä¸­éœ€è¦æ¸²æŸ“çš„å†…å®¹
        const nextIndex = tokens[index + 1];
        const content = nextIndex.type === 'fence' ? nextIndex.content : '';
        // å°†contentè§£æä¸ºvueç»„ä»¶åŸºæœ¬å±æ€§å¯¹è±¡
        let { template, script, styles } = parse({
          source: content,
          compiler: VueTemplateComplier,
          needMap: false
        });
        // å°†contentçš„å†…å®¹åˆ†åˆ«æç‚¼å‡ºæ¥å¹¶è½¬ç ï¼Œç»™codepenä½œä¸ºæäº¤è¡¨å•ä½¿ç”¨
        let rawCodepen = {
          html: (template && template.content || '').replace(/^(\/|\n)*/g, ''),
          js: (script && script.content || '').replace(/^(\/|\n)*/g, ''),
          css: (styles && styles.content || '').replace(/^(\/|\n)*/g, '')
        };
        let codepen = markdownIt.utils.escapeHtml(JSON.stringify(rawCodepen));
        // å°†templateè½¬ä¸ºrenderå‡½æ•°
        const { code } = compileTemplate({
          source: template.content,
          compiler: VueTemplateComplier
        });
        styleCodeList = styleCodeList.concat(styles);
        // è·å–scriptçš„ä»£ç 
        script = script ? script.content : '';
        if (script) {
          script = script.replace(
            /export\s+default/,
            'const exportJavaScript ='
          );
        } else {
          script = 'const exportJavaScript = {} ;';
        }
        // å°†ä»£ç è§£ææˆvueç»„ä»¶å­˜å‚¨ï¼Œç„¶ååœ¨æ¸²æŸ“htmlä¸­å¼•ç”¨è¯¥ç»„ä»¶
        const name = `st-demo-${componentCodeList.length}`;
        componentCodeList.push(`"${name}":(function () {
          ${code}
          ${script}
           return {
             ...exportJavaScript,
             render,
             staticRenderFns
          }
        })()`);
        // å°†éœ€è¦æ¸²æŸ“çš„ç¤ºä¾‹ç”¨code-blockç»„ä»¶åŒ…è£¹æ›¿æ¢æ’æ§½æ˜¾ç¤ºç¤ºä¾‹æ•ˆæœ
        return `<code-block :codepen="${codepen}">
                  <div slot="desc">${markdownIt.render(desc)}</div>
                  <template slot="demo"><${name} /></template>
                  <div slot="code">`;
      }
      return `    </div>
              		</code-block> `;
    }
  }
});
```
æ ¸å¿ƒé€»è¾‘å¦‚ä¸Šï¼Œè·å–åˆ°æ¯ä¸€å—`:::demo ä»£ç å— :::`é‡Œé¢çš„ä»£ç å—ï¼Œç„¶ååˆ†åˆ«è·å–åˆ°ä»£ç å—é‡Œé¢çš„HTMLæ¨¡æ¿ã€è„šæœ¬å’Œæ ·å¼ï¼Œä»–ä»¬æœ‰ä¸¤ä¸ªä½œç”¨ï¼Œä¸€æ˜¯ä¼ ç»™æˆ‘ä»¬çš„è‡ªå®šä¹‰ç»„ä»¶`code-block`ï¼Œåœ¨é‡Œé¢æˆ‘ä¼šå¯¹ä»£ç å—åšä¸€äº›æ ·å¼å’ŒåŠŸèƒ½æ€§çš„å°è£…ï¼›äºŒæ˜¯ç»„åˆæˆ`codepen`çš„æäº¤å‚æ•°ï¼Œcodepenæ˜¯ä¸€ä¸ªåœ¨çº¿ä»£ç ç¼–è¾‘å¹³å°ï¼Œå®ƒå¯ä»¥é€šè¿‡è¡¨å•æäº¤ä»£ç ç„¶åè·³è½¬æ¼”ç¤ºï¼ŒåŒæ ·çš„å¹³å°è¿˜æœ‰`jsfiddle`å’Œ`jsbin`ç­‰ã€‚è¿™é‡Œé¢æˆ‘ä½¿ç”¨`vue-template-compiler`å»æå–æ¨¡æ¿å˜é‡ï¼Œä½†æ˜¯ä½ ä¹Ÿå¯ä»¥ç”¨åˆ«çš„æ–¹å¼å»æå–ï¼Œæ¯”å¦‚cheerioğŸ‘‡
```js
const cheerio = require('cheerio');
function fetch (str, tag) {
  var $ = cheerio.load(str, { decodeEntities: false });
  if (!tag) return str;
  return $(tag).html();
}
// ...
let codepen = {
	html: fetch(content, 'template'),
	js: fetch(content, 'script'),
	css: fetch(content, 'style')
};
```
å› ä¸ºä¸€ä»½æ–‡æ¡£é‡Œé¢æœ‰å¤šä¸ªdemoï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ª`componentCodeList`å»å­˜å‚¨æ¯ä¸ªä»£ç å—ï¼Œç„¶åæœ€ç»ˆéå†æ’å…¥ï¼Œæœ€ç»ˆç”Ÿæˆä¸‹é¢è¿™ä¸ªæ¨¡æ¿å¹¶è¿”å›
```js
`<template>
  <div class="st-doc">
    ${markdownIt.render(source)}
  </div>
</template>
<script>
export default {
  name: 'st-doc',
  components: {
    ${componentCodeList.join(',')}
  }
}
</script>
<style>
  ${Array.from(styleCodeList, m => m.content).join('\n')}
</style>`
```
é™¤äº†å¤„ç†demoå†…çš„ä»£ç å—ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹`markdown-it`ç”Ÿæˆçš„HTMLæ ‡ç­¾åšä¸€äº›å¤„ç†ï¼Œå®ƒæœ¬èº«æä¾›ä¸€äº›ruleå…è®¸ä½ å¯¹å®ƒè¿›è¡Œä¸€äº›æ“ä½œï¼Œæ¯”å¦‚ç»™`table`æ ‡ç­¾æ›¿æ¢ä¸€ä¸ªç±»åğŸ‘‡
```js
markdownIt.renderer.rules.table_open = function() {
  return '<table class="st-doc__table">';
};
```
åŒæ—¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡`fence`è‡ªå·±å®šä¹‰æŸäº›æ ‡ç­¾çš„æ¸²æŸ“è§„åˆ™ï¼Œæ¯”å¦‚å¦‚æœåœ¨æ¨¡æ¿ä¸­ç”¨åˆ°æ’å€¼`{{ xx }}`ï¼Œå› ä¸ºæˆ‘ä»¬æŠŠæ•´ä¸ªæ–‡æœ¬è¿”å›ç»™`vue-loader`å¤„ç†ï¼Œå¦‚æœä¸å¯¹åŒå¤§æ‹¬å·åšå¤„ç†çš„è¯ï¼Œåœ¨æ˜¾ç¤ºçº¯æ–‡æœ¬çš„ä»£ç çš„æ—¶å€™ï¼ŒåŒå¤§æ‹¬å·ä¹Ÿä¼šå˜è§£ææˆæ¨¡æ¿ï¼Œåœ¨çˆ¶ç»„ä»¶å†…å°±ä¼šæŠ¥é”™æ‰¾ä¸åˆ°è¯¥å˜é‡ï¼Œæ‰€ä»¥éœ€è¦å†™ä¸€ä¸ªå‡½æ•°æ›¿æ¢åŒå¤§æ‹¬å·ğŸ‘‡

```js
markdownIt.renderer.rules.fence = genInlineLabel(markdownIt.renderer.rules.fence);
function genInlineLabel (render) {
  return function() {
  	return render.apply(this, arguments)
      .replace('{{', '{ { ')
      .replace('}}', ' } }');
  };
}
```

## CodeBlockç»„ä»¶
ä»ä¸Šé¢çœ‹åˆ°æˆ‘ä»¬æŠŠ`templateï¼Œjsï¼Œcss`æå–å‡ºæ¥ä¹‹åéƒ½æ³¨å…¥åˆ°äº†`CodeBlock`è¿™ä¸ªç»„ä»¶å½“ä¸­ï¼Œè¿™ä¸ªç»„ä»¶ä¸»è¦å°±æ˜¯åšä¸€äº›æ ·å¼ä¸Šçš„å¤„ç†åŒæ—¶æ·»åŠ è·³è½¬`codepen`çš„æ–¹æ³•ğŸ‘‡
```js
goCodepen() {
	// https://blog.codepen.io/documentation/api/prefill
	const { js, html, css } = this.codepen;
	const resourcesTpl =
		'<scr' +
		'ipt src="//unpkg.com/vue/dist/vue.js"></scr' +
		'ipt>' +
		'\n<scr' +
		`ipt src="//unpkg.com/steam-game-ui@${SteamUI.version}/lib/steam-game-ui.umd.min.js"></scr` +
		'ipt>';
	let jsTpl = (js || '').replace(/export default/, 'var Main =').trim();
	let htmlTpl = `${resourcesTpl}\n<div id="app">\n${html.trim()}\n</div>`;
	jsTpl = jsTpl
		? jsTpl + "\nvar Ctor = Vue.extend(Main)\nnew Ctor().$mount('#app')"
		: "new Vue().$mount('#app')";
	let cssTpl = `html { font-size: 100px; } #app{ font-size: 14px; }\n${css ||
		''}`;
	const data = { js: jsTpl, css: cssTpl, html: htmlTpl };
	const form =
		document.getElementById('fiddle-form') ||
		document.createElement('form');
	while (form.firstChild) {
		form.removeChild(form.firstChild);
	}
	form.method = 'POST';
	form.action = 'https://codepen.io/pen/define/';
	form.target = '_blank';
	form.style.display = 'none';

	const input = document.createElement('input');
	input.setAttribute('name', 'data');
	input.setAttribute('type', 'hidden');
	input.setAttribute('value', JSON.stringify(data));
	form.appendChild(input);
	document.body.appendChild(form);
	form.submit();
}
```
è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ç»™`codepen`å†™ä¸€æ®µæ³¨å…¥çš„ä»£ç ï¼Œå»å¼•ç”¨æˆ‘ä»¬å½“å‰å·²å‘å¸ƒçš„æœ€æ–°ç‰ˆæœ¬çš„ä»£ç åŒ…ï¼Œå› ä¸ºç»„ä»¶åº“æ‰˜ç®¡åœ¨npmä¸Šï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œå¼•ç”¨çš„æ˜¯`unpkg.com`ä¸Šçš„ä»£ç åŒ…ï¼Œåªè¦ä½ çš„åŒ…åœ¨npmä¸Šå‘å¸ƒäº†ï¼Œéƒ½ä¼šè¢«åŒæ­¥åˆ°`unpkg.com`ä¸­ã€‚æœ€åæˆ‘ä»¬åœ¨`main.js`ä¸­å…¨å±€æ³¨å†Œ`codeBlock`ç»„ä»¶`Vue.component('code-block', codeBlock)`ï¼Œè¿™æ ·å­å°±å¯ä»¥åœ¨æ‰€æœ‰åœ°æ–¹å¼•ç”¨è¯¥ç»„ä»¶äº†

## æ€»ç»“
æ•´ä¸ªæµç¨‹æ˜¯ä¸¤éƒ¨åˆ†ï¼šç¬¬ä¸€éƒ¨åˆ†æŠŠMarkdownæ–‡ä»¶è½¬æˆHTMLæ ‡ç­¾ï¼Œç¬¬äºŒéƒ¨åˆ†æå–`:::demo ä»£ç å— :::`ä»£ç å—é‡Œé¢çš„å†…å®¹ä¼ ç»™å…¨å±€çš„`codeBlock`ç»„ä»¶ï¼Œç„¶åæŠŠä¸€äºŒéƒ¨åˆ†åˆæˆä¸€ä¸ªç»„ä»¶æ¨¡æ¿ï¼Œä¼ ç»™`vue-loader`å»æ¸²æŸ“ï¼Œåœ¨å®˜ç½‘ä¸­æˆ‘ä»¬åªéœ€è¦åœ¨è·¯ç”±é‡Œé¢å¼•ç”¨Markdownæ–‡ä»¶å°±å¯ä»¥äº†ã€‚å…·ä½“çš„ä»£ç é€»è¾‘åœ¨`build/markdown-loader.js`